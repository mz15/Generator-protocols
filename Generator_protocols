'Const sample = "øàáëîí.dot"                                                             'Èìÿ ôàéëà-øàáëîíà ñ ðàñøèðåíèåì
Const file_extensions = ".doc"                                                          'Ðàñøèðåíèå ãåíåðèðóåìûõ ôàéëîâ
Const colomns = 10                                                                       'Êîë-âî îáðàáàòûâàåìûõ ñòîáöîâ (êîë-âî ïàðàìåòðîâ äëÿ çàìåíû)

Sub Generation()                                                                        'Ôóíêöèÿ ãåíåðàöèè ôàéëîâ

    Dim file_location As String
    With Application.FileDialog(msoFileDialogFilePicker)                                'Äèàëîã çàïðîñà âûáîðà ïàïêè
        .InitialFileName = Replace(ThisWorkbook.FullName, ThisWorkbook.name, "Øàáëîí.dot")
        .Title = "Âûáåðåòå ôàéë-øàáëîí"
        .AllowMultiSelect = False
        .ButtonName = "Âûáðàòü"
        .Show
        If .SelectedItems.Count = False Then Exit Sub                                   'Åñëè íè÷åãî íå âûáðàíî, ïðîãðàììà çàâåðøàåòñÿ
        file_location = .SelectedItems(1)                                               'Ðàñïîëîæåíèå ôàéëà-øàáëîíà
    End With

    Dim file_folder As String
    With Application.FileDialog(4)                                                      '(msoFileDialogFolderPicker) - äèàëîã çàïðîñà âûáîðà ôàéëà
        .InitialFileName = Replace(ThisWorkbook.FullName, ThisWorkbook.name, " ")
        .Title = "Âûáåðåòå ïàïêó, êóäà áóäóò ñîõðàíåíû ôàéëû"
        .AllowMultiSelect = False
        .ButtonName = "Âûáðàòü"
        If .Show = False Then Exit Sub                                                  'Åñëè íè÷åãî íå âûáðàíî, ïðîãðàììà çàâåðøàåòñÿ
        file_folder = .SelectedItems(1) & Application.PathSeparator                     'Ðàñïîëîæåíèå âûáðàííîé ïàïêè, â êîòîðóþ áóäóò ñîõðàíÿòüñÿ ôàéëû
    End With
    
    Dim last_line, number_of_files As Integer
    last_line = Cells(Rows.Count, "B").End(xlUp).Row                                    'Îïðåäåëåíèå ïîñëåäíåé íåïóñòîé ñòðîêè â ñòîëáöå B
    number_of_files = last_line - 4                                                     'Êîëè÷åñòâî ãåíåðèðóåìûõ ôàéëîâ (çàïîëíåííûõ ñòðîê)
    
    If number_of_files < 1 Then MsgBox "Íå çàäàíû ïàðàìåòðû äëÿ ãåíåðàöèè ôàéëîâ!", vbCritical: Exit Sub
                                                                                        'Åñëè íå çàäàíû ïàðàìåòðû äëÿ ãåíåðàöèè õîòÿ áû îäíîãî ôàéëà

    Dim line As Range
    Dim WA As Object, WD As Object: Set WA = CreateObject("Word.Application")
    
    For Each line In ActiveSheet.Rows("5:" & last_line)                                 'Öèêë ñ 5 ñòðîêè äî ïîñëåäíåé çàïîëíåííîé
        With line
            name = Trim$(.Cells(2))                                                     'Ïðèñâîåíèå èìåí ãåíåðèðóåìûì ôàéëàì
            file_name = file_folder & name & file_extensions                            'Ðàñïîëîæåíèå, èìÿ è ðàñøèðåíèå ñãåíåðèðîâàííûõ ôàéëîâ

            Set WD = WA.Documents.Add(file_location): DoEvents
            
            For i = 2 To colomns + 1                                                    'Öèêë ñ 1 ñòîëáöà äî ÷èñëà, ðàâíîìó êîë-âó îáðàáàòûâàåìûõ ñòîëáöîâ
                FindText = Cells(3, i): ReplaceText = Trim$(.Cells(i))                  'Ïîèñê ñîâïàäåíèé ñ ìåòêàìè è çàìåíà íà çíà÷åíèÿ â áàçå äàííûõ

                With WD.Range.Find
                    .Text = FindText                                                    'Ìåòêà â øàáëîíå
                    .Replacement.Text = ReplaceText                                     'Çàìåíà ìåòêè òåêñòîì èç áàçû äàííûõ
                    .Forward = True                                                     'Íàïðàâëåíèå ïîèñêà (âïåðåä/íàçàä)
                    .MatchCase = True                                                   'Ó÷èòûâàòü ðåãèñòð
                    .MatchWholeWord = True                                              'Èñêàòü ñëîâî öåëèêîì
                    .MatchAllWordForms = False                                          'Âñå ñëîâîôîðìû
                    .Execute Replace:=True                                              'Çàïóñê çàìåíû
                End With
                DoEvents
            Next i
            
            WD.SaveAs file_name: WD.Close False: DoEvents                               'Ñîõðàíåíèé è çàêðûòèå ñîçäàííîãî ôàéëà
        End With
    Next line                                                                           'Ïåðåõîä ê ñëåäóþùåé èòåðàöèè öèêëà (ñòðîêå áàçû äàííûõ)

    WA.Quit False
    MsgBox "Â ïàïêå " & file_folder & " ñîçäàíî " & number_of_files & " ôàéëîâ.", vbInformation, "Ñîçäàíèå ôàéëîâ çàâåðøåíî"
End Sub

'-----------------------------------------------------
'Äðóãîé ñïîñîá ââîäà øàáëîíà è ïàïêè:
'Dim Log As Boolean
'Log = True
'While Log = True
'NextIteration:
'sample = InputBox("Ââåäèòå èìÿ ôàéëà (ñ ðàñøèðåíèåì) øàáëîíà äëÿ ãåíåðèðóåìûõ ôàéëîâ." _
'& vbNewLine & vbNewLine & "Íàïðèìåð: øàáëîí.dot", "Øàáëîí", "øàáëîí.dot")   'Ââîä èìåíè ôàéëà øàáëîíà
'If sample = "" Or sample = " " Then GoTo NextIteration
'file_location = Replace(ThisWorkbook.FullName, ThisWorkbook.Name, "øàáëîí.dot")   'Ðàñïîëîæåíèå øàáëîíà äëÿ ãåíåðèðóåìûõ ôàéëîâ
'If Dir(file_location) <> "" Then Log = False Else: MsgBox "Ôàéë  " & sample & "  íå íàéäåí", vbExclamation, "Ôàéë íå íàéäåí"                                                                                   'Ïðîâåðêà íà ñóùåñòâîàíèå ôàéëà
'Wend
'Log = True
'While Log = True
'NewFolderName = Replace(ThisWorkbook.FullName, ThisWorkbook.Name, InputBox("Ââåäèòå èìÿ ïàïêè, êóäà áóäóò ñîõðàíåíû ñãåíåðèðîâàííûå ôàéëû", "Èìÿ ïàïêè"))
'MkDir NewFolderName 'Ñîçäàíèå íîâîãî êàòàëîãà (MkDir ðàñïîëîæåíèå)
'If Dir(NewFolderName) = "" Then Log = False Else: MsgBox "íåâåðíûé"
'Wend
'file_location = Replace(ThisWorkbook.FullName, ThisWorkbook.Name, sample)              'Ðàñïîëîæåíèå øàáëîíà äëÿ ãåíåðèðóåìûõ ôàéëîâ
'file_folder = NewFolderName & Application.PathSeparator                                'Íàçâàíèå ïàïêè, â êîòîðóþ ñãåíåðèðóþòñÿ ôàéëû
'-----------------------

Sub FillingColumns()
    Dim last_line_B, last_line_C, last_line_D As Integer
    last_line_B = Cells(Rows.Count, "B").End(xlUp).Row
    last_line_C = Cells(Rows.Count, "C").End(xlUp).Row
    last_line_D = Cells(Rows.Count, "D").End(xlUp).Row
    last_line_I = Cells(Rows.Count, "I").End(xlUp).Row
    last_line_J = Cells(Rows.Count, "J").End(xlUp).Row
    last_line_K = Cells(Rows.Count, "K").End(xlUp).Row

    If last_line_B <= 4 Then MsgBox "Ñíà÷àëà íåîáõîäèìî çàïîëíèòü õîòÿ áû îäíó ñòðîêó": Exit Sub
    If last_line_B <> last_line_C Or last_line_B <> last_line_D Then MsgBox "Ñòðîêà çàïîëíåíà íå ïîëíîñòüþ!": Exit Sub

    For i = 5 To last_line_B
        If Range("B" & i) = "" Or Range("C" & i) = "" Or Range("D" & i) = "" Then MsgBox "Ñòðîêà çàïîëíåíà íå ïîëíîñòüþ!": Exit Sub
    Next i
    
    If last_line_B <= last_line_I Or last_line_B <= last_line_J Or last_line_B <= last_line_K Then MsgBox "Âñå ñòîëáöû óæå çàïîëíåíû!": Exit Sub
    
    Call GenitiveStudents
    Call GenitiveProfessor
    Call FillingFormulas
End Sub

Sub Clearing()
    Dim last_line As Integer

    For m = 1 To 10
        last_line = Cells(Rows.Count, m).End(xlUp).Row
        If last_line < 5 Then Else Rows("5:" & last_line).Delete Shift:=xlUp
    Next m
    
    If Range("A2") <> "" Or Range("C2") <> "" Then If MsgBox("Óäàëèòü êîä è íàçâàíèå ñïåöèàëüíîñòè?", vbYesNo) = vbYes Then Range("B2, C2").ClearContents
    If Range("D2") <> "" Then If MsgBox("Óäàëèòü íîìåð ãðóïïû?", vbYesNo) = vbYes Then Range("D2").ClearContents

End Sub

Function FillingFormulas()
    Dim last_line_B, last_line_I As Integer
        Dim last_line_J, last_line_C, last_line_D As Integer
    last_line_B = Cells(Rows.Count, "B").End(xlUp).Row
    last_line_C = Cells(Rows.Count, "C").End(xlUp).Row
    last_line_D = Cells(Rows.Count, "D").End(xlUp).Row
    last_line_I = Cells(Rows.Count, "I").End(xlUp).Row
    last_line_J = Cells(Rows.Count, "J").End(xlUp).Row
    last_line_K = Cells(Rows.Count, "K").End(xlUp).Row
    

    
    
    
    Range("A5:A" & last_line_B).Formula = "=ROW(A1)"                  'Çàïîëíåíèå ñòîëáöà ñ íóìåðàöèåé
    Range("E5:E" & last_line_B).Formula = Range("E2").Formula         'Ïðåîáðàçîâàíèå ïîëíîãî ÔÈÎ ñòóäåíòà â Ôàìèëèÿ È.Î.
    Range("G5:G" & last_line_B).Formula = Range("G2").Formula         'Ïðåîáðàçîâàíèå ïîëîãî ÔÈÎ ðóêîâîäèòåëÿ â Ôàìèëèÿ È.Î.
    
    Range("D2").Copy
    Range("I" & last_line_I + 1 & ":I" & last_line_B).PasteSpecial Paste:=xlPasteValues     'Çàïîëíåíèå ñòîëáöà ñ íîìåðîì ãðóïïû
    
    Range("C2").Copy
    Range("J" & last_line_J + 1 & ":J" & last_line_B).PasteSpecial Paste:=xlPasteValues     'Çàïîëíåíèå ñòîëáöà ñ íàçâàíèåì ñïåöèàëüíîñòè
    
    Range("B2").Copy
    Range("K" & last_line_K + 1 & ":K" & last_line_B).PasteSpecial Paste:=xlPasteValues     'Çàïîëíåíèå ñòîëáöà ñ êîäîì ñïåöèàëüíîñòè
    Application.CutCopyMode = False
    
    'Range("E5").AutoFill Destination:=Range("E5:E" & last_line)
    '"=ËÅÂÑÈÌÂ(B5;ÏÎÈÑÊ(" ";B5)+1) & "." & ÏÑÒÐ(B5;ÏÎÈÑÊ(" ";B5;ÏÎÈÑÊ(" ";B5)+1)+1;1) & ".""
End Function

Function GenitiveStudents() 'Ôóíêöèÿ ñêëîíåíèÿ ÔÈÎ ñòóäåíòîâ â ðîäèòåëüíûé ïàäåæ
   
    Dim surname As String, name As String, patronymic As String
    Dim last_line As Integer
    last_line = Cells(Rows.Count, "B").End(xlUp).Row 'Ïîñëåäíÿÿ çàïîëíåííàÿ ñòðîêà ñ ÔÈÎ ñòóäåíòà
    
    For i = 5 To last_line
        Dim fname$(): fname = Split(Cells(i, "B")) 'Ïðåîáðàçîâàíèå â ìàññèâ ñ òðåìÿ ýëåìåíòàìè

        If Len(fname(0)) > 0 And Len(fname(1)) > 0 And Len(fname(2)) > 0 Then
            surname = fname(0)
            name = fname(1)
            patronymic = fname(2)
            Cells(i, "F") = genitive(surname, name, patronymic)
        Else: Exit Function
        End If
    Next
End Function

Function GenitiveProfessor() 'Ôóíêöèÿ ñêëîíåíèÿ ÔÈÎ ðóêîâîäèòåëåé â ðîäèòåëüíûé ïàäåæ
    For i = 5 To Cells(Rows.Count, "D").End(xlUp).Row 'Öèêë âûäåëåíèÿ ÔÈÎ ðóêîâîäèòåëåé èç ñòîëáöà D
    Dim fio As Integer
        With Cells(i, "D")
            fio = InStr(.Text, ",") 'Îïðåäåëåíèå ïîçèöèè ïåðâîé çàïÿòîé
            Cells(i, "H") = Left(.Text, fio - 1) 'Îñòàâëÿåì òîëüêî ÔÈÎ
        End With
    Next

    Dim surname As String, name As String, patronymic As String
    For i = 5 To Cells(Rows.Count, "H").End(xlUp).Row
        Dim fname$(): fname = Split(Cells(i, "H")) 'Ïðåîáðàçîâàíèå â ìàññèâ ñ òðåìÿ ýëåìåíòàìè
        surname = fname(0)
        name = fname(1)
        patronymic = fname(2)
        If surname <> "" And name <> "" And patronymic <> "" Then Cells(i, "H") = genitive(surname, name, patronymic)
        'Åñëè åñòü âñå òðè ñëîâà, òî âûïîëíÿåòñÿ ôóíêöèÿ ñêëîíåíèÿ
    Next
End Function

Function genitive(surname As String, name As String, patronymic As String) As String
    Dim fMan As Boolean
    fMan = (Right(patronymic, 1) = "÷") 'Îïðåäåëåíèå, ìóæñêîå ÔÈÎ èëè æåíñêîå

    If surname <> "" Then
        If fMan Then 'Ñêëîíåíèå ìóæñêîé ôàìèëèè
            Select Case Right(surname, 1)
                Case "î", "è", "ÿ", "à"
                    genitive = surname
                Case "é"
                    genitive = Mid(surname, 1, Len(surname) - 2) & "îãî"
            Case Else
                    genitive = surname & "à"
            End Select
        Else 'Ñêëîíåíèå æåíñêîé ôàìèëèè
            Select Case Right(surname, 1)
                Case "î", "è", "á", "â", "ã", "ä", "æ", "ç", "ê", "ë", "ì", "í", "ï", "ð", "ñ", "ò", "ô", "õ", "ö", "÷", "ø", "ù", "ü"
                    genitive = surname
                Case "ÿ"
                    genitive = Mid(surname, 1, Len(surname) - 2) & "îé"
            Case Else
                genitive = Mid(surname, 1, Len(surname) - 1) & "îé"
            End Select
        End If
    End If
    
    genitive = genitive & " " 'Äîáàâëåíèå ïðîáåëà ïîñëå ôàìèëèè
    
    If name <> "" Then
        If fMan Then 'Ñêëîíåíèå ìóæñêîãî èìåíè
            Select Case Right(name, 1)
                Case "é", "ü"
                    genitive = genitive & Mid(name, 1, Len(name) - 1) & "ÿ"
                Case "à"
                    genitive = genitive & Mid(name, 1, Len(name) - 1) & "û"
            Case Else
                genitive = genitive & name & "à"
            End Select
        Else 'Ñêëîíåíèå æåíñêîãî èìåíè
            Select Case Right(name, 1)
                Case "à"
                    Select Case Mid(name, Len(name) - 1, 1)
                        Case "è", "ã"
                            genitive = genitive & Mid(name, 1, Len(name) - 1) & "è"
                    Case Else
                        genitive = genitive & Mid(name, 1, Len(name) - 1) & "û"
                    End Select
                Case "ÿ"
                    If Mid(name, Len(name) - 1, 1) = "è" Then
                        genitive = genitive & Mid(name, 1, Len(name) - 1) & "è"
                    Else
                        genitive = genitive & Mid(name, 1, Len(name) - 1) & "è"
                    End If
                Case "ü"
                    genitive = genitive & Mid(name, 1, Len(name) - 1) & "è"
                Case Else
                    genitive = genitive & name
                End Select
        End If
    End If
    genitive = genitive & " " 'Äîáàâëåíèå ïðîáåëà ïîñëå èìåíè

    If patronymic <> "" Then
        If fMan Then 'Ñêëîíåíèå ìóæñêîãî îò÷åñòâà
            genitive = genitive & patronymic & "à"
        Else 'Ñêëîíåíèå æåíñêîãî îò÷åñòâà
            genitive = genitive & Mid(patronymic, 1, Len(patronymic) - 1) & "û"
        End If
    End If
End Function

'Function Possessive(ParamArray cNames() As Variant) As String
'Application.Volatile True
'Dim aParam() As String
'aParam = Split(Trim(Join(cNames, " ")))
'If UBound(aParam) < 2 Then
'Possessive = ""
'Else
'Possessive = genitive(aParam(0), aParam(1), aParam(2))
'End If
'End Function
